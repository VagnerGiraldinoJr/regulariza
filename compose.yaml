services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      APP_NAME: ${APP_NAME:-Regulariza}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:-http://localhost:${APP_PORT:-8082}}

      LOG_CHANNEL: ${LOG_CHANNEL:-stack}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-regulariza}
      DB_USERNAME: ${DB_USERNAME:-regulariza}
      DB_PASSWORD: ${DB_PASSWORD:-regulariza123}

      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-database}
      CACHE_STORE: ${CACHE_STORE:-database}
      SESSION_DRIVER: ${SESSION_DRIVER:-database}
      SESSION_LIFETIME: ${SESSION_LIFETIME:-120}

      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-null}

      STRIPE_KEY: ${STRIPE_KEY:-}
      STRIPE_SECRET: ${STRIPE_SECRET:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}

      ZAPI_INSTANCE: ${ZAPI_INSTANCE:-}
      ZAPI_TOKEN: ${ZAPI_TOKEN:-}
      ZAPI_CLIENT_TOKEN: ${ZAPI_CLIENT_TOKEN:-}

      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '${APP_PORT:-8082}:8000'

  queue:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    command: ['php', 'artisan', 'queue:work', '--tries=1', '--timeout=120', '--sleep=3']
    environment:
      APP_NAME: ${APP_NAME:-Regulariza}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:-http://localhost:${APP_PORT:-8082}}
      LOG_CHANNEL: ${LOG_CHANNEL:-stack}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-regulariza}
      DB_USERNAME: ${DB_USERNAME:-regulariza}
      DB_PASSWORD: ${DB_PASSWORD:-regulariza123}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-database}
      CACHE_STORE: ${CACHE_STORE:-database}
      SESSION_DRIVER: ${SESSION_DRIVER:-database}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-null}
      STRIPE_KEY: ${STRIPE_KEY:-}
      STRIPE_SECRET: ${STRIPE_SECRET:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      ZAPI_INSTANCE: ${ZAPI_INSTANCE:-}
      ZAPI_TOKEN: ${ZAPI_TOKEN:-}
      ZAPI_CLIENT_TOKEN: ${ZAPI_CLIENT_TOKEN:-}
      RUN_MIGRATIONS: 'false'
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  mysql:
    image: mysql:8.4
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      MYSQL_DATABASE: ${DB_DATABASE:-regulariza}
      MYSQL_USER: ${DB_USERNAME:-regulariza}
      MYSQL_PASSWORD: ${DB_PASSWORD:-regulariza123}
    volumes:
      - regulariza_mysql_data:/var/lib/mysql
    ports:
      - '${FORWARD_DB_PORT:-3308}:3306'
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-p${MYSQL_ROOT_PASSWORD:-root123}']
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:alpine
    restart: unless-stopped
    volumes:
      - regulariza_redis_data:/data
    ports:
      - '${FORWARD_REDIS_PORT:-6381}:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  regulariza_mysql_data:
  regulariza_redis_data:
